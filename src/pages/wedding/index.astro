---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Wedding">
    <form>
        <label for="file">Upload a photo:</label>
        <input type="file" id="file" name="file" accept="image/*" required />
        <button type="submit">Upload</button>
    </form>
    <div id="image"></div>
</Layout>

<script>
    document.querySelector('form').addEventListener('submit', function (event) {
        event.preventDefault();
        const fileInput = document.getElementById('file') as HTMLInputElement;
        const file = fileInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const arrayBuffer = e.target.result;
                const blob = new Blob([arrayBuffer], { type: file.type });
                console.log(blob);
                // You can now use the blob, e.g., upload it to a server or display it'
                const uploadBlob = async () => {
                    const response = await fetch('/api/phblobs', {
                        method: 'POST',
                        body: blob
                    });
                    const data = await response.json();
                    if (data.message) {
                        localStorage.setItem('blobId', data.key);
                        console.log('blobId: ' + data.key);
                    }
                };
                uploadBlob().then(() => {
                    //Request the image from the server
                    const requestImage = async () => {
                        const blobId = localStorage.getItem('blobId');
                        const response = await fetch(`/api/phblobs?key=${blobId}`, {
                            method: 'GET',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const data = await response.blob();
                        console.log('blob data');
                        console.log(data);

                        //Display the image
                        if (data) {
                            const image = document.createElement('img');
                            image.src = URL.createObjectURL(data);
                            image.width = 200;
                            image.height = 200;
                            document.getElementById('image').appendChild(image);
                        }
                    };
                    requestImage();
                });
            };
            reader.readAsArrayBuffer(file);
        }
    });
</script>
